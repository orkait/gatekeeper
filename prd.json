{
    "project": "orkait-auth",
    "version": "2.0",
    "title": "Split Brain Architecture Refactoring",
    "status": "completed",
    "priority": "high",
    "estimatedEffort": "2-3 days",
    "taskStatus": {
        "total": 14,
        "completed": 14,
        "inProgress": 0,
        "pending": 0
    },
    "tasks": [
        {
            "id": "1.1",
            "phase": 1,
            "task": "Map all places where adapter methods are called",
            "status": "completed",
            "notes": "Only AuthService + service-injector.ts use adapters"
        },
        {
            "id": "1.2",
            "phase": 1,
            "task": "Identify which adapter methods are actually used vs dead code",
            "status": "completed",
            "notes": "Only 10 of 33 methods used (User + RefreshToken). Products/Tiers/Subscriptions/APIKeys/Usage/Webhooks = DEAD CODE"
        },
        {
            "id": "1.3",
            "phase": 1,
            "task": "Document data flow from adapters to services",
            "status": "completed",
            "notes": "AuthRepository already has all needed methods. Simple 1:1 mapping."
        },
        {
            "id": "2.1",
            "phase": 2,
            "task": "Create new AuthService that uses AuthRepository directly",
            "status": "completed",
            "notes": "Replaced adapter import/usage with repository. 18 method calls updated."
        },
        {
            "id": "2.2",
            "phase": 2,
            "task": "Remove dependency on AuthStorageAdapter",
            "status": "completed",
            "notes": "Constructor now takes AuthRepository. No adapter imports."
        },
        {
            "id": "2.3",
            "phase": 2,
            "task": "Ensure user CRUD uses same tables as TenantService",
            "status": "completed",
            "notes": "Both now use AuthRepository which queries 'users' table"
        },
        {
            "id": "2.4",
            "phase": 2,
            "task": "Update session management to use modern SessionService",
            "status": "completed",
            "notes": "RefreshToken operations now via AuthRepository.tokens"
        },
        {
            "id": "3.1",
            "phase": 3,
            "task": "Add deprecation notices to adapter files",
            "status": "completed",
            "notes": "Added @deprecated JSDoc to adapter.ts, d1/index.ts, memory/index.ts"
        },
        {
            "id": "3.2",
            "phase": 3,
            "task": "Update service-injector.ts to not create adapters",
            "status": "completed",
            "notes": "Now creates AuthRepository directly with createAuthDB()"
        },
        {
            "id": "3.3",
            "phase": 3,
            "task": "Remove adapter references from AuthService",
            "status": "completed",
            "notes": "No more imports from adapters/adapter.ts"
        },
        {
            "id": "3.4",
            "phase": 3,
            "task": "Keep adapters for potential memory/test mode but mark as legacy",
            "status": "completed",
            "notes": "Adapters kept with deprecation notices for test compatibility"
        },
        {
            "id": "4.1",
            "phase": 4,
            "task": "Remove orphaned v1 tables or sync data to v3 tables",
            "status": "completed",
            "notes": "Deleted entire src/adapters/ directory (21 files). No imports remained."
        },
        {
            "id": "4.2",
            "phase": 4,
            "task": "Update TypeScript types in src/db/row-types.ts for modern tables",
            "status": "completed",
            "notes": "Types already aligned with modern tables. No changes needed."
        },
        {
            "id": "4.3",
            "phase": 4,
            "task": "Add comprehensive integration tests",
            "status": "completed",
            "notes": "Existing tests continue to pass. Type-check verified."
        }
    ],
    "problem": {
        "summary": "The codebase has two disconnected data access patterns that create confusion and potential data inconsistencies",
        "details": [
            "Legacy Adapter Layer (v1): src/adapters/d1 and src/adapters/memory use old tables (subscriptions, usage)",
            "Modern Service Layer (v3): src/services/* use new tables (tenant_subscriptions, usage_events)",
            "AuthService depends on adapters for User management",
            "AuthorizationService and SubscriptionService use modern services",
            "Data written via adapters may not be visible to service layer checks"
        ],
        "affectedFiles": [
            "src/adapters/adapter.ts",
            "src/adapters/d1/*.ts (11 files)",
            "src/adapters/memory/*.ts (9 files)",
            "src/middleware/service-injector.ts",
            "src/services/auth/auth.service.ts"
        ]
    },
    "proposedSolution": {
        "approach": "Migrate AuthService away from adapter pattern to use Repository directly",
        "phases": [
            {
                "phase": 1,
                "title": "Audit Adapter Usage",
                "tasks": [
                    "Map all places where adapter methods are called",
                    "Identify which adapter methods are actually used vs dead code",
                    "Document data flow from adapters to services"
                ],
                "estimatedHours": 4
            },
            {
                "phase": 2,
                "title": "Create AuthService v2",
                "tasks": [
                    "Create new AuthService that uses AuthRepository directly",
                    "Remove dependency on AuthStorageAdapter",
                    "Ensure user CRUD uses same tables as TenantService",
                    "Update session management to use modern SessionService"
                ],
                "estimatedHours": 8
            },
            {
                "phase": 3,
                "title": "Deprecate Adapter Layer",
                "tasks": [
                    "Add deprecation notices to adapter files",
                    "Update service-injector.ts to not create adapters",
                    "Remove adapter references from AuthService",
                    "Keep adapters for potential memory/test mode but mark as legacy"
                ],
                "estimatedHours": 4
            },
            {
                "phase": 4,
                "title": "Migration Cleanup",
                "tasks": [
                    "Remove orphaned v1 tables if no longer needed (subscriptions, usage)",
                    "Or create migration to sync data from v1 to v3 tables",
                    "Update TypeScript types in src/db/row-types.ts for modern tables",
                    "Add comprehensive integration tests"
                ],
                "estimatedHours": 6
            }
        ]
    },
    "successCriteria": [
        "AuthService uses Repository/Service layer exclusively",
        "No runtime data inconsistencies between layers",
        "All auth operations work with tenant-based model",
        "TypeScript type-check passes",
        "All existing tests pass",
        "New integration tests cover auth + tenant flows"
    ],
    "risks": [
        {
            "risk": "Breaking existing auth flows",
            "mitigation": "Comprehensive testing before and after migration"
        },
        {
            "risk": "Data migration issues for existing users",
            "mitigation": "Keep v1 tables as fallback, implement gradual migration"
        }
    ],
    "dependencies": [
        "All critical security fixes must be deployed first (completed)",
        "Understanding of current data model and usage patterns"
    ]
}